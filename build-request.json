{
  "kind": "build_request",
  "title": "Implement TP/SL live order execution and Accept/Reject AI recommendation actions",
  "projectName": "Crypto Position Monitor",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-118",
      "text": "Audit and fix the TP/SL order execution logic in useAITradeMonitoring.ts so that when a live AI trade's price crosses TP1, TP2, TP3, or the effective stop-loss, the corresponding real Binance order actions are triggered. Specifically: (1) When TP1 is crossed and tp1Executed is false — mark tp1Executed = true, cancel the original STOP_MARKET order via cancelOrder(), place a new STOP_MARKET at the entry price (breakeven), and persist the updated effectiveSL and riskManagementStep ('breakeven') to localStorage under 'ai_daily_trades'. (2) When TP2 is crossed and tp2Executed is false — mark tp2Executed = true, cancel the current STOP_MARKET order, place a new STOP_MARKET at the TP1 price (trailing), and persist effectiveSL and riskManagementStep ('trailing'). (3) When TP3 is crossed and tp3Executed is false — mark tp3Executed = true, place a MARKET close order for the full position quantity on the opposite side, record the closed trade in AI trade history with full TP3 profit, set status to 'TP Hit', and trigger auto-regeneration for that modality. (4) When the effective SL is crossed — place a MARKET close order on the opposite side, record the trade as 'SL Hit' in history, and trigger auto-regeneration. All Binance order calls must use binanceOrderService.ts and only fire when BOTH isLiveTradingEnabled() returns true AND getModalityLiveOrders()[trade.modality] is true. Each call must be individually wrapped in try/catch with a 10-second Promise.race timeout. If an order call fails, log the error, show a toast (e.g., 'TP1 order update failed — SL not moved to breakeven'), and continue updating the local trade state regardless.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Nao. Nesse momento preciso saber se o aplicativo consegue adicionar uma posição de tp1 direto na binance. Automaticamente. Eou clicando na recomendação.",
          "Sim por favor."
        ]
      },
      "acceptanceCriteria": [
        "When TP1 price is crossed in a live AI trade (isLiveTradingEnabled true AND modality live orders enabled), the existing STOP_MARKET order is cancelled and a new STOP_MARKET is placed at the entry price (breakeven) on Binance Futures",
        "When TP2 price is crossed and TP1 has already been executed, the current STOP_MARKET is cancelled and replaced with a STOP_MARKET at the TP1 price on Binance Futures",
        "When TP3 price is crossed and TP2 has already been executed, a MARKET close order is placed on the opposite side, the trade is recorded as 'TP Hit' in AI trade history, and auto-regeneration is triggered",
        "When the effectiveSL is crossed, a MARKET close order is placed, the trade is recorded as 'SL Hit', and auto-regeneration is triggered",
        "Each Binance order call is individually wrapped in try/catch with a 10-second Promise.race timeout",
        "If an order call fails, a toast is shown (e.g., 'TP1 order update failed — SL not moved to breakeven') and the local trade state is still updated",
        "When both live trading conditions are false, the existing local/simulated TP execution flow continues unchanged",
        "Updated trade state (executed TP flags, effectiveSL, riskManagementStep) is persisted to localStorage under 'ai_daily_trades' after each action"
      ]
    },
    {
      "id": "REQ-119",
      "text": "Implement Accept and Reject functionality for AI take-profit recommendation suggestions displayed in the 'AI Insights' tab (AIInsightsTab.tsx) via the AdjustmentSuggestionCard component. When the user clicks 'Accept' on a TP adjustment suggestion for a monitored position: (1) If live trading mode is ON and credentials are present, call placeTakeProfitMarketOrder() from binanceOrderService.ts with the suggested TP price and the appropriate position quantity and side, wrapped in try/catch with a 10-second timeout; show a toast 'TP order placed on Binance: {price}' on success or 'TP order failed: {error}' on failure. (2) Regardless of live trading mode, update the position's stored TP level(s) in localStorage (under the 'positions' key) with the newly accepted TP price, so the PositionCard and PositionDashboard reflect the updated target immediately. (3) Record the accepted suggestion in the adjustment history stored in localStorage (using the existing AdjustmentHistoryRecord type from frontend/src/types/adjustment.ts) with outcome 'accepted'. When the user clicks 'Reject' on a TP adjustment suggestion: (1) Do not place any order. (2) Dismiss the suggestion card from the UI. (3) Record the rejection in adjustment history with outcome 'dismissed'. The accept/reject callbacks must be wired from AIInsightsTab.tsx down to AdjustmentSuggestionCard.tsx via props, using the existing onAccept and onDismiss prop signatures already defined on the component.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Eou clicando na recomendação.",
          "Sim por favor."
        ]
      },
      "acceptanceCriteria": [
        "Clicking 'Accept' on a TP suggestion in the AI Insights tab, with live trading ON and credentials present, calls placeTakeProfitMarketOrder() with the suggested TP price",
        "A toast 'TP order placed on Binance: {price}' is shown on success; 'TP order failed: {error}' on failure",
        "Regardless of live trading mode, the accepted TP price is immediately saved to the position in localStorage and reflected in PositionCard/PositionDashboard",
        "The accepted suggestion is recorded in adjustment history with outcome 'accepted'",
        "Clicking 'Reject' dismisses the suggestion card from the UI without placing any order",
        "Rejected suggestion is recorded in adjustment history with outcome 'dismissed'",
        "The suggestion card disappears from the UI immediately after either accept or reject — no stale card lingers",
        "onAccept and onDismiss callbacks are correctly wired from AIInsightsTab.tsx to AdjustmentSuggestionCard.tsx via props and are not no-ops or undefined"
      ]
    },
    {
      "id": "REQ-120",
      "text": "Implement Accept and Reject functionality for AI stop-loss adjustment suggestions displayed in the 'AI Insights' tab via the AdjustmentSuggestionCard component. When the user clicks 'Accept' on an SL adjustment suggestion: (1) If live trading mode is ON and credentials are present, cancel the existing STOP_MARKET order for the position (using the stored Binance order ID if available, otherwise call getOpenOrders() to locate it) and place a new STOP_MARKET order at the suggested SL price with the appropriate quantity and side, both calls wrapped in try/catch with a 10-second timeout each; show toasts for success/failure of each step individually. (2) Regardless of live trading mode, update the position's stored stopLoss price in localStorage (under the 'positions' key) with the newly accepted SL price immediately. (3) Record the accepted suggestion in adjustment history with outcome 'accepted'. When the user clicks 'Reject' on an SL adjustment suggestion: (1) Do not place or cancel any orders. (2) Dismiss the suggestion card from the UI. (3) Record the rejection in adjustment history with outcome 'dismissed'.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Eou clicando na recomendação.",
          "Sim por favor."
        ]
      },
      "acceptanceCriteria": [
        "Clicking 'Accept' on an SL suggestion with live trading ON and credentials present cancels the existing STOP_MARKET order on Binance and places a new STOP_MARKET at the suggested SL price",
        "Each Binance call (cancel + new order) is individually wrapped in try/catch with a 10-second timeout, with individual success/failure toasts",
        "Regardless of live trading mode, the accepted SL price is immediately saved to the position in localStorage and reflected in all position displays",
        "The accepted suggestion is recorded in adjustment history with outcome 'accepted'",
        "Clicking 'Reject' dismisses the suggestion card from the UI without placing or cancelling any orders",
        "Rejected suggestion is recorded in adjustment history with outcome 'dismissed'",
        "The suggestion card disappears from the UI immediately after either accept or reject"
      ]
    },
    {
      "id": "REQ-121",
      "text": "Ensure the AdjustmentSuggestionCard component (frontend/src/components/AdjustmentSuggestionCard.tsx) and its rendering inside AIInsightsTab.tsx (frontend/src/components/AIInsightsTab.tsx) correctly wire the onAccept and onDismiss callbacks. Audit the current implementation: (1) Verify that AIInsightsTab.tsx passes functional onAccept and onDismiss handler props to each AdjustmentSuggestionCard — these must not be undefined, no-ops, or missing. (2) Ensure the 'Accept' and 'Reject'/'Dismiss' buttons inside AdjustmentSuggestionCard call these props when clicked, with the suggestion object passed as the argument. (3) If the component currently uses a local dismiss-only state without calling onAccept, refactor it so that the parent (AIInsightsTab) controls the accepted/dismissed state via the callbacks and removes the suggestion from its rendered list on both accept and dismiss. (4) The suggestion cards must disappear from the UI immediately after accept or reject is clicked, with no stale card lingering.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Sim por favor."
        ]
      },
      "acceptanceCriteria": [
        "AIInsightsTab.tsx passes non-null, functional onAccept and onDismiss props to every AdjustmentSuggestionCard it renders",
        "The 'Accept' button in AdjustmentSuggestionCard calls onAccept with the suggestion object",
        "The 'Reject'/'Dismiss' button in AdjustmentSuggestionCard calls onDismiss with the suggestion object",
        "AIInsightsTab controls accepted/dismissed state and removes the card from its list on both actions",
        "No stale suggestion card remains visible after accept or dismiss"
      ]
    }
  ],
  "constraints": [
    "All Binance order calls must use binanceOrderService.ts functions already implemented in the codebase",
    "Live Binance orders must only fire when BOTH isLiveTradingEnabled() is true AND the per-modality toggle is enabled — never in simulated mode",
    "Each individual Binance API call must be wrapped in its own try/catch with a 10-second Promise.race timeout",
    "Position and AI trade state must be saved to localStorage regardless of whether Binance order calls succeed or fail",
    "Do not modify files in frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, or frontend/src/components/ui"
  ],
  "nonGoals": [
    "Adding new order types beyond MARKET, STOP_MARKET, and TAKE_PROFIT_MARKET",
    "Implementing limit order entry for positions",
    "Changes to the backend Motoko canister",
    "Redesigning the AI Insights tab layout beyond wiring the accept/reject callbacks",
    "Modifying the trade selection algorithm or SMC analysis logic"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}