{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix AI Daily Trades P&L showing 0.00 — live price not applied to trade cards",
  "requirements": [
    {
      "id": "REQ-133",
      "summary": "Fix the AI Daily Trades P&L calculation in AIDailyTradesSection.tsx so that live current prices are reliably fetched before PnL calculation runs, and pass a loading flag to AITradeCard when prices are not yet available",
      "acceptanceCriteria": [
        "AIDailyTradesSection fetches current prices from https://fapi.binance.com/fapi/v1/ticker/price for every open AI trade symbol before rendering AITradeCard components.",
        "The enriched trade objects passed to AITradeCard contain a currentPrice value that is a valid non-zero number.",
        "If price data has not yet loaded, AITradeCard renders a loading indicator (e.g., spinner or '--') instead of '0.00' for PnL fields.",
        "Once a valid price is received, PnL in USD and percentage is calculated correctly using pnlCalculations.ts with the correct entry price, current price, leverage, investment, and position type.",
        "PnL values update automatically on each polling cycle without requiring a page refresh."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/AIDailyTradesSection.tsx",
          "operation": "modify",
          "description": "Audit and fix the price fetching mechanism inside AIDailyTradesSection to ensure the fetch from https://fapi.binance.com/fapi/v1/ticker/price completes and returns valid non-zero prices before building enriched trade objects. Add validation to check that currentPrice is a finite number greater than zero. If the price is still loading (0, undefined, or null), include a 'priceLoading: true' flag in the enriched trade object instead of passing an invalid price. Ensure the polling mechanism correctly awaits the price fetch and handles errors gracefully. Review the calculatePnl invocation to verify all five required parameters (entryPrice, currentPrice, leverage, investment, positionType) are passed with valid values."
        }
      ]
    },
    {
      "id": "REQ-134",
      "summary": "Fix AITradeCard.tsx to guard against zero or undefined currentPrice before calling PnL calculation, displaying a loading indicator when price is unavailable and correct color-coded PnL when valid",
      "acceptanceCriteria": [
        "AITradeCard never displays '0.00' PnL when currentPrice has not loaded — it shows a loading indicator instead.",
        "PnL in USD and percentage is only computed when currentPrice is a finite number greater than zero.",
        "calculatePnl (or pnlCalculations.ts equivalent) is called with all five required arguments: entryPrice, currentPrice, leverage, investment, and positionType.",
        "Green color is applied to positive PnL values and red to negative PnL values.",
        "The daily performance summary header in AIDailyTradesSummary correctly aggregates PnL only from trades that have a valid price loaded."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/AITradeCard.tsx",
          "operation": "modify",
          "description": "Add defensive guards at the top of the PnL calculation logic to check that currentPrice is a finite number greater than zero before invoking calculatePnl from pnlCalculations.ts. When currentPrice is invalid (zero, undefined, null, or not finite), render a loading indicator (e.g., a Loader2 spinner icon or '...' text) in place of the PnL USD and percentage values. When currentPrice is valid, compute PnL by calling calculatePnl with all five required arguments: entryPrice, currentPrice, leverage, investment, and positionType. Apply green color (text-green-500 or text-green-600) to positive PnL values and red color (text-red-500 or text-red-600) to negative PnL values. Ensure the card displays '--' or a spinner icon consistently when the price is not yet loaded, and switches to the computed PnL once a valid price arrives."
        },
        {
          "path": "frontend/src/components/AIDailyTradesSummary.tsx",
          "operation": "modify",
          "description": "Update the daily performance summary aggregation logic to filter out or skip trades that have priceLoading: true or invalid currentPrice values when computing total PnL and win/loss counts. Ensure only trades with valid, loaded prices contribute to the summary metrics. This prevents the summary from showing misleading 0.00 totals when prices have not yet been fetched."
        }
      ]
    },
    {
      "id": "REQ-135",
      "summary": "Fix the duplicate 'Day Trading' modality card in the AI Daily Trades tab by deduplicating stored trades and adding a guard to prevent duplicate insertions",
      "acceptanceCriteria": [
        "The AI Daily Trades tab always renders exactly four trade cards: one for Scalping, one for Day Trading, one for Swing Trading, and one for Trend Following.",
        "No two cards share the same modality label.",
        "If the current localStorage 'ai_daily_trades' array contains duplicate modality entries, the duplicates are removed on next load (keeping the most recently generated trade per modality).",
        "The deduplication guard in the storage write path prevents inserting a second open trade for any modality that already has an open trade."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useAITradeStorage.ts",
          "operation": "modify",
          "description": "Add a deduplication function that runs when reading trades from localStorage. When loading the 'ai_daily_trades' array, detect duplicate modality entries (multiple trades with the same modality and status 'Open') and keep only the most recent trade per modality (by comparing id or createdAt timestamps). Export this deduplication helper and apply it in the getAllAITrades or equivalent read function. Additionally, add a guard in the addAITrade (or storage write) function to check if a trade with the same modality and status 'Open' already exists before inserting a new trade. If a duplicate is detected, skip the insertion or replace the existing trade instead of adding a second entry."
        },
        {
          "path": "frontend/src/hooks/useAITradeGeneration.ts",
          "operation": "modify",
          "description": "Review the AI trade generation logic to ensure it does not create duplicate trades for the same modality. Before generating or persisting a new trade, check the existing stored trades to confirm that the target modality does not already have an open trade. If an open trade exists for a modality, skip generation for that modality. This guard complements the storage-level deduplication to prevent duplicates from being created upstream."
        }
      ]
    }
  ]
}